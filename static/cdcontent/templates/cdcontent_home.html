{% extends 'spoken/templates/base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block title %}CD Content Creation{% endblock %}
{% block cssblock %}
    <style type="text/css">
        .add-foss{
            margin-right: 15px;
        }
        #id_language {
            min-height: 180px;
        }
    </style>
{% endblock %}
{% block heading %}CD Content Creation{% endblock %}
{% block search %} {% endblock %}
{% block content %}
    <form role="form" method="post" enctype="multipart/form-data" class="cdcontentform form-horizontal">
        <div class="row well bs-component">
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
                <div class="alert alert-danger" role="alert">
                  <strong>Note:</strong> The maximum file size to download is 1 GB.
                </div>
                <fieldset>
                    {% csrf_token %}
                    <div class="form-group">
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 col-lg-offset-3 col-md-offset-3 col-sm-offset-3">
                            {{ form.selected_foss.errors }}
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="id_foss_category" class="col-lg-3 col-md-3 col-sm-3 col-xs-3 control-label">FOSS Category:</label>
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
                            {% render_field form.foss_category class+="form-control foss_category" tabindex="1" %}
                            {{ form.foss_category.errors }}
                            <small>Please select FOSS</small>
                            {% render_field form.selected_foss class+='selected_foss' %}
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="id_level" class="col-lg-3 col-md-3 col-sm-3 col-xs-3 control-label">Level:</label>
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
                            {% render_field form.level class+="form-control level" tabindex="2" %}
                            {{ form.level.errors }}
                            <small>Please select the Level</small>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="id_language" class="col-lg-3 col-md-3 col-sm-3 col-xs-3 control-label">Languages: <span class='ajax-refresh ajax-refresh-language'><i class="fa fa-2 fa-refresh fa-spin"></i></span></label>
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
                            {% render_field form.language class+="form-control language" tabindex="3" %}
                            {{ form.language.errors }}
                            <small>For selecting multiple languages, please use </small>
                            <small><b>&lt;CTRL&gt; + Click</b>.</small>
                        </div>
                    </div>

                    <div>
                        <div class="form-group">
                            <input name="tutorials_check" class="tutorials_check" type="checkbox" for="id_tutorials" class="col-lg-3 col-md-3 col-sm-3 col-xs-3 control-label">
                            <label class="col-lg-9 col-md-9 col-sm-9 col-xs-9">Check this to select individual tutorials
                                <small><i><br>( i.e. Not entire FOSS)</i></small></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9 col-lg-offset-3 col-md-offset-3 col-sm-offset-3">
                            <span class='ajax-refresh ajax-refresh-add-foss'><i class="fa fa-2 fa-refresh fa-spin"></i></span>
                            <input type="button" class="add_foss_lang btn btn-primary" value="Add selected FOSS"  tabindex="4" />
                            <input type="submit" class="btn btn-primary" value="Create ZIP file"  tabindex="5" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="id_tutorials" class="col-lg-3 col-md-3 col-sm-3 col-xs-3 control-label">Tutorials:</label>
                        <div class="col-lg-9 col-md-9 col-sm-9 col-xs-9">
                            {% render_field form.tutorial_names class+="form-control tutorial_names" tabindex="2" %}
                            {{ form.level.errors }}
                            <small>Choose the tutorials to download</small>
                        </div>
                    </div>

                </fieldset>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
                <div class="table-responsive">
                    <table class="added-foss table table-condensed table-bordered table-hover">
                    </table>
                </div>
                <div class="download-link"></div>
            </div>
        </div>
    </form>
{% endblock %}
{% block jsblock %}
    <script type="text/javascript">
        $(document).ready(function(){
            if($('.foss_category').val() == '') {
                $('.level').attr("disabled", "disabled");
                $('.language').attr("disabled", "disabled");
                $('.tutorials_check').attr("disabled", "disabled");
                $('.tutorial_names').attr("disabled", "disabled");

            }
            $('.foss_category').on("change", function(){
                $('.level').val('');
                $('.language').html('');
                $('.tutorials_check').attr('checked',false)
                $('.tutorial_names').html('');
                if($('.foss_category').val() == '') {
                    $('.level').attr("disabled", "disabled");
                    $('.language').attr("disabled", "disabled");
                    $('.tutorials_check').attr("disabled", "disabled");
                }else {
                    $('.level').removeAttr('disabled');
                    $('.tutorials_check').removeAttr("disabled");
                }
            });

            $(".cdcontentform").on( "submit", function(event) {
                event.preventDefault();
                var url = $(location).attr('href');
                alert("url"+url);
                $('.download-link').html('<i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading...</span> please do not refresh the page, we are preparing your download link');
                var posting = $.post(url, $(this).serialize());

                posting.done(function(data) {
                    console.log(data.status);
                    alert("posting"+data);
                    if(data.status) {
                        var downloadLink = '<a href="' + data.path + '" title="Download cd content zip">Click here</a> to download the cd content zip file';
                        $('.download-link').html(downloadLink);
                    } else {
                        var message = 'Something went wrong! please refresh the page and try again.'
                        $('.download-link').html(message);
                    }
                });
                posting.fail(function() {
                    var message = 'Something went wrong! please refresh the page and try again.'
                    $('.download-link').html(message);
                });
            });

            $('.level').on("change", function(){
                var foss = $('.foss_category').val();
                var level = $(this).val();
                $('.language').html('');
                $('.language').attr("disabled", "disabled");
                if(foss && level) {
                    $.ajax({
                        url: "/cdcontent/ajax-fill-languages/",
                        type: "POST",
                        data: {
                            foss: foss,
                            level: level,
                        },
                        beforeSend: function() {
                            $('.ajax-refresh-language').show();
                        },
                        success: function(data) {
                            // loading languages
                            if(data) {
                                $('.language').html(data);
                                $('.language').removeAttr('disabled');
                            }
                            $('.ajax-refresh-language').hide();
                        }
                    });
                
            }
            });

            $('.language').on("change", function(){
                var language = JSON.stringify($('.language').val());
                alert(language);
                $('.tutorials_check').attr('checked',false)
                $('.tutorial_names').html('');
                $(".tutorials_check").click(function () {                
                    var foss = $('.foss_category').val();
                    
                    
                    var level = $('.level').val();
                    var tutorials = $('.tutorials_check').is(":checked");
                    if (tutorials) {
                        $('.tutorial_names').html('');
                        $.ajax({
                            url: "/cdcontent/ajax-fill-tutorials/",
                            type: "POST",
                            data: {
                                foss: foss,
                                level: level,
                                language: language
                            },
                            beforeSend: function() {
                                $('.ajax-refresh-tutorials').show();
                            },
                            success: function(data) {
                                // loading languages
                                if(data) {
                                    $('.tutorial_names').html(data);
                                    $('.tutorial_names').removeAttr('disabled');
                                }
                                $('.ajax-refresh-tutorials').hide();
                        }
                    });
                }
            })
        });

            $('.add_foss_lang').on("click", function(){
                foss = $('.foss_category').val();
                level = $('.level').val();
                langs = JSON.stringify($('.language').val());
                tutorials = JSON.stringify($('.tutorial_names').val());
                var tutorial_checked = $('.tutorials_check').is(":checked");
                console.log(langs)
                selectedfoss = $('.selected_foss').val();
                if(foss && langs && level) {
                    $.ajax({
                        url: "/cdcontent/ajax-add-foss/",
                        type: "POST",
                        data: {
                            foss: foss,
                            langs: langs,
                            level: level,
                            selectedfoss: selectedfoss,
                            tutorials: tutorials,
                            tutorials_check : tutorial_checked,
                        },
                        beforeSend: function() {
                            $('.add_foss_lang').css('display', 'none');
                            $('.ajax-refresh-add-foss').show();
                        },
                        success: function(data) {
                            data = JSON.parse(data);
                            if(data) {
                                data = JSON.stringify(data);
                                if(data != '{}') {
                                    $('.selected_foss').val(data);
                                } else {
                                    $('.selected_foss').val('');
                                }
                            }
                            $.ajax({
                                url: "/cdcontent/ajax-show-added-foss/",
                                type: "POST",
                                data: {
                                    selectedfoss: $('.selected_foss').val(),
                                },
                                beforeSend: function() {
                                    $('.add_foss_lang').css('display', 'none');
                                    $('.ajax-refresh-add-foss').show();
                                },
                                success: function(data) {
                                    //data = JSON.parse(data);
                                    header = '<caption class="col-left"><b>Selected FOSS List:<span class="pull-right"> ~ Total Size : '+data[1]+'</span></b></caption><tr><th>FOSS</th><th>Languages</th><th>Size</th>';
                                    if(data) {
                                        $('.added-foss').html(header + data[0]);
                                        console.log(data);
                                    }
                                    $('.ajax-refresh-add-foss').hide();
                                }
                            });
                            $('.ajax-refresh-add-foss').hide();
                            $('.add_foss_lang').show();
                        }
                    });
                    $('.add_foss_lang').show();
                    $('.ajax-refresh-add-foss').hide();
                }
            });
        });
    </script>
{% endblock %}
