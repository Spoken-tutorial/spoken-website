{% extends 'spoken/templates/base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block title %}Academic Subscription{% endblock %}
{% block cssblock %}
    <link rel="stylesheet" href="{% static 'spoken/css/chosen.min.css' %}" type="text/css" media="screen" charset="utf-8" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet">
    <style>
     .text-danger{
        font-size: 1.2rem;
     }
    </style>
{% endblock %}
{% block heading %}
        <i class="fa fa-list-ul"></i> Annual Academic Subscription
{% endblock %}

{% block content %}
{% if messages %}

{% endif %}
    <div >
        <div >
            <form method="post" onsubmit="return validateAllGSTForms();">
                {% csrf_token %}
            
                <div class="row">
                    <div class="form-group col-sm-6">
                        <label><i class="fa fa-user"></i> Name:</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-user"></i></span>
                            {% render_field form.name class+="form-control" placeholder="Enter your full name" %}
                        </div>
                    </div>
                
                    <div class="form-group col-sm-6">
                        <label><i class="fa fa-envelope"></i> Email:</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-envelope"></i></span>
                            {% render_field form.email class+="form-control" placeholder="Enter your email" %}
                        </div>
                        <div class="text-danger">
                            {% for error in form.email.errors %}
                                <small><i class="fa fa-exclamation-circle"></i> {{ error }}</small>
                            {% endfor %}
                        </div>
                    </div>
                
                    <div class="form-group col-sm-6">
                        <label><i class="fa fa-phone"></i> Phone:</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-phone"></i></span>
                            {% render_field form.phone class+="form-control" placeholder="Enter phone number" %}
                        </div>
                        <div class="text-danger">
                            {% for error in form.phone.errors %}
                                <small><i class="fa fa-exclamation-circle"></i> {{ error }}</small>
                            {% endfor %}
                        </div>
                    </div>
                
                    <div class="form-group col-sm-6">
                        <label><i class="fa fa-map-marker"></i> State:</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-map-marker"></i></span>
                            {% render_field form.state class+="form-control" %}
                        </div>
                    </div>
                
                    <div class="form-group col-sm-12">
                        <label><i class="fa fa-university"></i> Academic Institute:</label>
                        <span style="color: green; display: none;" id="ac_info">Loading academic centers data, please wait ....</span>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-building"></i></span>
                            <select multiple id="id_academic" style="width:100%" name="institute" class="form-control"></select>
                        </div>
                        <small class="text-muted">You can search institute by academic code or name.</small>
                        <small class="text-muted">Payment can be made for multiple institutes simultaneously.</small>
                    </div>
                
                    <div class="form-group col-sm-6">
                        <label><i class="fa fa-money"></i> Amount:</label>
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-inr"></i></span>
                            <input id="id_amount" disabled class="form-control">
                        </div>
                    </div>
                    <div id="gst-error-message" style="color: red; margin-top: 10px;" class="form-group col-sm-12"></div>
                    <div id="gst-fields-container" class="col-sm-12"></div>
                
                    <button class="btn btn-primary btn-block">
                        <i class="fa fa-credit-card"></i> Make Payment
                    </button>
                </div>
            </form>
            
          <div id="paymentMsg">

          </div>
        </div>
    </div>
   
{% endblock %}
{% block jsblock %}
    <script src="{% static 'spoken/js/events.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

    <script>
       $(document).ready(function() {
        $('#id_academic').select2();
        $("#e1").select2();
        $("#id_state").val("").trigger("change");

        $("#id_state").change(function(){
            var stateId = $(this).val();
            let academicSelect = $("#id_academic");

            // Reset and disable academic dropdown
            academicSelect.prop('disabled', true);
            document.getElementById("ac_info").style.display = "inline";
            academicSelect.html('<option value="">Loading...Please wait</option>');

            if(stateId){
                fetch(`{% url 'donate:get_academic_centers' %}?stateId=${stateId}`)
                .then(response => response.json())
                .then(data => {
                    academicSelect.html('<option value="">-- Select Academic Center --</option>'); // reset
                    data.forEach(item => {
                        academicSelect.append(new Option(`${item.academic_code} - ${item.institution_name}`, item.id))
                    });
                    academicSelect.prop('disabled', false); // enable after loading
                    document.getElementById("ac_info").style.display = "none";
                })
                .catch(error =>alert('An error occurred. Please try later.'))
            }
        });

        $('#id_academic').on('select2:select select2:unselect', function (e) {
            var selectedCount = $(this).val() ? $(this).val().length : 0;
            let total_amount = {{subscription_amount}} * selectedCount;
            $("#id_amount").val(total_amount);
        });
    });

    function generateGstFields(selectedOptions) {
            const container = $('#gst-fields-container');
            container.empty(); // Clear previous inputs
    
            selectedOptions.each(function () {
                const val = $(this).val();
                const text = $(this).text();
                const idSafe = val.replace(/[^a-zA-Z0-9]/g, '_'); // for ID use
    
                const block = `
                    <div class="gst-entry institute-block" id="gst-${idSafe}" style="border: 1px solid #ddd; padding: 10px; border-radius: 8px; margin-bottom:5px;">
                        <h5><b><i class="fa fa-university"></i> ${text}</b></h5>
                        <div class="row" >
                            <div class="form-group col-sm-3"  style="display:inline">
                            <label for="gst_no_${idSafe}">GST Number:</label>
                            <input type="text" class="form-control gst-number" name="gst_no_${val}" id="gst_no_${idSafe}" required>
                            </div>
                            <div class="form-group col-sm-6"  style="display:inline">
                                <label for="gst_name_${idSafe}">Name as per GST:</label>
                                <input type="text" class="form-control gst-name" name="gst_name_${val}" id="gst_name_${idSafe}" required>
                            </div>
                            <div class="form-group col-sm-3"  style="display:inline">
                                <label for="pan_no_${idSafe}">PAN Number:</label>
                                <input type="text" class="form-control pan-number" name="pan_no_${val}" id="pan_no_${idSafe}" required>
                            </div>      
                        </div>
                        <hr>
                    </div>
                `;
    
                container.append(block);
            });
        }
    
        // Trigger on page load and on selection change
        const academicSelect = $('select[name="institute"]');
        generateGstFields(academicSelect.find('option:selected'));
    
        academicSelect.change(function () {
            generateGstFields($(this).find('option:selected'));
        });

        function validateAllGSTForms() {
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[A-Z0-9]{1}Z[A-Z0-9]{1}$/;
            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
        
            const container = document.getElementById("gst-fields-container");
            const errorDiv = document.getElementById("gst-error-message");
            errorDiv.innerText = ""; // clear previous

            const blocks = container.querySelectorAll(".institute-block");
            let messages = [];
            let isValid = true;
            blocks.forEach((block, index) => {
                const gst = block.querySelector(".gst-number")?.value.trim() || "";
                const pan = block.querySelector(".pan-number")?.value.trim() || "";
                const name = block.querySelector(".gst-name")?.value.trim() || "";
        
                const anyFilled = gst || pan || name;
                if (anyFilled) {
                    if (gst && !gstRegex.test(gst)) {
                        messages.push(`Entry ${index + 1}: Invalid GST Number`);
                        isValid = false;
                    }
        
                    if (pan && !panRegex.test(pan)) {
                        messages.push(`Entry ${index + 1}: Invalid PAN Number`);
                        isValid = false;
                    }
        
                    if (!name) {
                        messages.push(`Entry ${index + 1}: Name is required if GST or PAN is filled`);
                        isValid = false;
                    }
                }
            });
        
            if (!isValid) {
                errorDiv.innerHTML = "<p>Please check below errors: </p><ul><li>" + messages.join("</li><li>") + "</li></ul>";
            }
            return isValid;
        }
    </script>
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->
   
                
    
    
{% endblock %}
